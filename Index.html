<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheda Assistito v3.4 - Distretto 50 Trapani</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .version-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 16px;
            opacity: 0.95;
        }

        .project-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            margin-top: 15px;
            border-radius: 10px;
            font-size: 13px;
            text-align: left;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 15px 30px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #28a745;
        }

        .status-dot.disconnected {
            background: #dc3545;
        }

        .status-dot.loading {
            background: #ffc107;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .stats-bar {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px 30px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 150px;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            display: block;
        }

        .stat-label {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }

        .action-bar {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .action-btn.primary {
            background: #28a745;
            color: white;
        }

        .action-btn.primary:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .action-btn.secondary {
            background: #17a2b8;
            color: white;
        }

        .action-btn.secondary:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .action-btn.warning {
            background: #ffc107;
            color: #000;
        }

        .action-btn.warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .form-content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 22px;
            color: #667eea;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        label .required {
            color: #dc3545;
            margin-left: 3px;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="date"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        select {
            cursor: pointer;
            background: white;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Stile per data di nascita con campi separati */
        .date-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-input-group input {
            text-align: center;
            font-size: 16px;
            font-weight: 600;
        }

        .date-input-group input[name="giorno"],
        .date-input-group input[name="mese"] {
            width: 70px;
            min-width: 70px;
        }

        .date-input-group input[name="anno"] {
            width: 90px;
            min-width: 90px;
        }

        .date-input-group span {
            font-size: 18px;
            font-weight: bold;
            color: #999;
        }

        .age-display {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 150px;
        }

        .age-display.empty {
            background: #e9ecef;
            color: #999;
        }

        .caregiver-card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .caregiver-header {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 15px;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        button.btn-primary {
            padding: 15px 40px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        button.btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        button.btn-secondary {
            padding: 15px 40px;
            font-size: 16px;
            font-weight: 600;
            border: 2px solid #667eea;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            color: #667eea;
        }

        button.btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.5s ease;
            font-weight: 500;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .close-btn {
            font-size: 30px;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            line-height: 1;
            padding: 0 10px;
        }

        .close-btn:hover {
            color: #333;
        }

        .schede-list {
            display: grid;
            gap: 15px;
        }

        .scheda-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .scheda-item:hover {
            border-color: #667eea;
            background: #f0f3ff;
            transform: translateX(5px);
        }

        .filter-bar {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
        }

        .filter-bar select {
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #667eea;
            font-size: 14px;
            min-width: 200px;
        }

        @media (max-width: 768px) {
            .form-content {
                padding: 20px;
            }

            .header h1 {
                font-size: 22px;
            }

            .version-badge {
                position: static;
                margin-bottom: 10px;
                display: inline-block;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                width: 100%;
                justify-content: center;
            }

            .action-bar {
                flex-direction: column;
            }

            .status-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .stats-bar {
                flex-direction: column;
            }

            .stat-card {
                width: 100%;
            }

            .date-input-group {
                flex-direction: column;
            }

            .date-input-group input {
                width: 100% !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="version-badge">üìã v3.4</div>
            <h1>üìã SCHEDA RACCOLTA DATI ASSISTITO</h1>
            <p>Comune di Trapani - Distretto 50</p>
            <p style="font-size: 14px; opacity: 0.9; margin-top: 5px;">
                9 Comuni: Trapani ‚Ä¢ Erice ‚Ä¢ Valderice ‚Ä¢ Paceco ‚Ä¢ Misiliscemi ‚Ä¢ Custonaci ‚Ä¢ San Vito Lo Capo ‚Ä¢ Favignana ‚Ä¢ Buseto Palizzolo
            </p>
            <div class="project-info">
                <strong>üìÖ Progetto PNRR TeleCare H24</strong><br>
                Obiettivo: 100 assistiti | Periodo: Nov 2025 - Mar 2026
            </div>
        </div>

        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot connected" id="statusDot"></div>
                <span id="statusText">‚úÖ Pronto per l'uso</span>
            </div>
            <div class="status-indicator">
                üìä Schede totali: <strong id="totalSchede">-</strong>
            </div>
        </div>

        <div class="stats-bar" id="statsBar" style="display: none;">
            <div class="stat-card">
                <span class="stat-number" id="statTotale">0</span>
                <span class="stat-label">Totale Assistiti</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="statComune">0</span>
                <span class="stat-label">Comuni Coperti</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="statPiuComune">-</span>
                <span class="stat-label">Comune con Pi√π Assistiti</span>
            </div>
        </div>

        <div class="action-bar">
            <button class="action-btn secondary" onclick="caricaSchede()">
                üîÑ Ricarica Schede
            </button>
            <button class="action-btn secondary" onclick="mostraListaSchede()">
                üìã Visualizza Tutte le Schede
            </button>
            <button class="action-btn secondary" onclick="mostraStatistiche()">
                üìä Statistiche per Comune
            </button>
        </div>

        <div class="form-content">
            <!-- Messaggio -->
            <div class="message" id="messageBox"></div>

            <form id="assistitoForm">
                <!-- DATI ASSISTITO -->
                <div class="section">
                    <h2 class="section-title">üë§ Dati Assistito</h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="numeroScheda">N¬∞ Scheda<span class="required">*</span></label>
                            <input type="text" id="numeroScheda" name="numeroScheda" required>
                        </div>

                        <div class="form-group">
                            <label for="dataCompilazione">Data Compilazione</label>
                            <input type="date" id="dataCompilazione" name="dataCompilazione">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="nome">Nome<span class="required">*</span></label>
                            <input type="text" id="nome" name="nome" required>
                        </div>

                        <div class="form-group">
                            <label for="cognome">Cognome<span class="required">*</span></label>
                            <input type="text" id="cognome" name="cognome" required>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Data di Nascita<span class="required">*</span></label>
                            <div class="date-input-group">
                                <input type="number" id="giorno" name="giorno" placeholder="GG" min="1" max="31" maxlength="2" required>
                                <span>/</span>
                                <input type="number" id="mese" name="mese" placeholder="MM" min="1" max="12" maxlength="2" required>
                                <span>/</span>
                                <input type="number" id="anno" name="anno" placeholder="AAAA" min="1900" max="2025" maxlength="4" required>
                            </div>
                            <input type="hidden" id="dataNascita" name="dataNascita">
                        </div>

                        <div class="form-group">
                            <label>Et√†</label>
                            <div class="age-display empty" id="ageDisplay">
                                üéÇ - anni
                            </div>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label for="indirizzoResidenza">Indirizzo Residenza</label>
                            <input type="text" id="indirizzoResidenza" name="indirizzoResidenza">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="comune">Comune di Residenza<span class="required">*</span></label>
                            <select id="comune" name="comune" required>
                                <option value="">Seleziona il comune...</option>
                                <option value="Trapani">üèõÔ∏è Trapani (46)</option>
                                <option value="Erice">üèõÔ∏è Erice (19)</option>
                                <option value="Valderice">üèõÔ∏è Valderice (8)</option>
                                <option value="Paceco">üèõÔ∏è Paceco (8)</option>
                                <option value="Misiliscemi">üèõÔ∏è Misiliscemi (7)</option>
                                <option value="Custonaci">üèõÔ∏è Custonaci (4)</option>
                                <option value="San Vito Lo Capo">üèõÔ∏è San Vito Lo Capo (3)</option>
                                <option value="Favignana">üèõÔ∏è Favignana (3)</option>
                                <option value="Buseto Palizzolo">üèõÔ∏è Buseto Palizzolo (2)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="telFisso">Telefono Fisso</label>
                            <input type="tel" id="telFisso" name="telFisso" placeholder="0923...">
                        </div>

                        <div class="form-group">
                            <label for="cellulare">Cellulare</label>
                            <input type="tel" id="cellulare" name="cellulare" placeholder="333...">
                        </div>
                    </div>
                </div>

                <!-- CAREGIVER -->
                <div class="section">
                    <h2 class="section-title">üë• Caregiver</h2>

                    <div class="caregiver-card">
                        <div class="caregiver-header">Caregiver B</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="caregiverB_nome">Nome</label>
                                <input type="text" id="caregiverB_nome" name="caregiverB_nome">
                            </div>
                            <div class="form-group">
                                <label for="caregiverB_cognome">Cognome</label>
                                <input type="text" id="caregiverB_cognome" name="caregiverB_cognome">
                            </div>
                            <div class="form-group">
                                <label for="caregiverB_parentela">Parentela</label>
                                <input type="text" id="caregiverB_parentela" name="caregiverB_parentela" placeholder="Es: Figlio/a">
                            </div>
                            <div class="form-group">
                                <label for="caregiverB_email">Email</label>
                                <input type="email" id="caregiverB_email" name="caregiverB_email">
                            </div>
                            <div class="form-group">
                                <label for="caregiverB_cellulare">Cellulare</label>
                                <input type="tel" id="caregiverB_cellulare" name="caregiverB_cellulare">
                            </div>
                            <div class="form-group">
                                <label for="caregiverB_chiavi">Chiavi</label>
                                <select id="caregiverB_chiavi" name="caregiverB_chiavi">
                                    <option value="">-</option>
                                    <option value="SI">‚úÖ SI</option>
                                    <option value="NO">‚ùå NO</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="caregiver-card">
                        <div class="caregiver-header">Caregiver C</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="caregiverC_nome">Nome</label>
                                <input type="text" id="caregiverC_nome" name="caregiverC_nome">
                            </div>
                            <div class="form-group">
                                <label for="caregiverC_cognome">Cognome</label>
                                <input type="text" id="caregiverC_cognome" name="caregiverC_cognome">
                            </div>
                            <div class="form-group">
                                <label for="caregiverC_parentela">Parentela</label>
                                <input type="text" id="caregiverC_parentela" name="caregiverC_parentela">
                            </div>
                            <div class="form-group">
                                <label for="caregiverC_email">Email</label>
                                <input type="email" id="caregiverC_email" name="caregiverC_email">
                            </div>
                            <div class="form-group">
                                <label for="caregiverC_cellulare">Cellulare</label>
                                <input type="tel" id="caregiverC_cellulare" name="caregiverC_cellulare">
                            </div>
                            <div class="form-group">
                                <label for="caregiverC_chiavi">Chiavi</label>
                                <select id="caregiverC_chiavi" name="caregiverC_chiavi">
                                    <option value="">-</option>
                                    <option value="SI">‚úÖ SI</option>
                                    <option value="NO">‚ùå NO</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="caregiver-card">
                        <div class="caregiver-header">Caregiver D</div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="caregiverD_nome">Nome</label>
                                <input type="text" id="caregiverD_nome" name="caregiverD_nome">
                            </div>
                            <div class="form-group">
                                <label for="caregiverD_cognome">Cognome</label>
                                <input type="text" id="caregiverD_cognome" name="caregiverD_cognome">
                            </div>
                            <div class="form-group">
                                <label for="caregiverD_parentela">Parentela</label>
                                <input type="text" id="caregiverD_parentela" name="caregiverD_parentela">
                            </div>
                            <div class="form-group">
                                <label for="caregiverD_email">Email</label>
                                <input type="email" id="caregiverD_email" name="caregiverD_email">
                            </div>
                            <div class="form-group">
                                <label for="caregiverD_cellulare">Cellulare</label>
                                <input type="tel" id="caregiverD_cellulare" name="caregiverD_cellulare">
                            </div>
                            <div class="form-group">
                                <label for="caregiverD_chiavi">Chiavi</label>
                                <select id="caregiverD_chiavi" name="caregiverD_chiavi">
                                    <option value="">-</option>
                                    <option value="SI">‚úÖ SI</option>
                                    <option value="NO">‚ùå NO</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label for="scalettaContatti">Scaletta Contatti C.O.</label>
                        <textarea id="scalettaContatti" name="scalettaContatti" placeholder="Ordine di priorit√† per contattare i caregiver..."></textarea>
                    </div>
                </div>

                <!-- ALTRI DATI ASSISTITO -->
                <div class="section">
                    <h2 class="section-title">üìù Altri Dati Assistito</h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="natoA">Nato a</label>
                            <input type="text" id="natoA" name="natoA">
                        </div>
                        <div class="form-group">
                            <label for="provincia">Provincia</label>
                            <input type="text" id="provincia" name="provincia" maxlength="2" placeholder="TP">
                        </div>
                        <div class="form-group">
                            <label for="codiceFiscale">Codice Fiscale</label>
                            <input type="text" id="codiceFiscale" name="codiceFiscale" maxlength="16" style="text-transform: uppercase;">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="tipoAbitazione">Tipo Abitazione</label>
                            <select id="tipoAbitazione" name="tipoAbitazione">
                                <option value="">Seleziona...</option>
                                <option value="Appartamento">üè¢ Appartamento</option>
                                <option value="Casa">üè† Casa Indipendente</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="piano">Piano</label>
                            <input type="number" id="piano" name="piano" min="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label for="ascensore">Ascensore</label>
                            <select id="ascensore" name="ascensore">
                                <option value="">-</option>
                                <option value="SI">‚úÖ SI</option>
                                <option value="NO">‚ùå NO</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sesso">Sesso</label>
                            <select id="sesso" name="sesso">
                                <option value="">-</option>
                                <option value="M">üë® M</option>
                                <option value="F">üë© F</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="peso">Peso (kg)</label>
                            <input type="number" id="peso" name="peso" min="0" placeholder="70">
                        </div>
                        <div class="form-group">
                            <label for="altezza">Altezza (cm)</label>
                            <input type="number" id="altezza" name="altezza" min="0" placeholder="170">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label for="patologie">Patologie e Fragilit√†</label>
                            <textarea id="patologie" name="patologie" placeholder="Elencare patologie croniche e condizioni di fragilit√†..."></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label for="farmaci">Farmaci e Orari</label>
                            <textarea id="farmaci" name="farmaci" placeholder="Es: ore 08:00 Cardioaspirin 100mg, ore 20:00 Eutirox 50mcg..."></textarea>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="freqCardiacaMin">Freq. Cardiaca Min (bpm)</label>
                            <input type="number" id="freqCardiacaMin" name="freqCardiacaMin" placeholder="60">
                        </div>
                        <div class="form-group">
                            <label for="freqCardiacaMax">Freq. Cardiaca Max (bpm)</label>
                            <input type="number" id="freqCardiacaMax" name="freqCardiacaMax" placeholder="100">
                        </div>
                        <div class="form-group">
                            <label for="saturazioneMin">Saturazione Min (%)</label>
                            <input type="number" id="saturazioneMin" name="saturazioneMin" min="70" max="100" placeholder="95">
                        </div>
                    </div>
                </div>

                <!-- AUSILI ED ECG -->
                <div class="section">
                    <h2 class="section-title">üîß Ausili ed ECG</h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="poltrone">Poltrone con Sensori</label>
                            <select id="poltrone" name="poltrone">
                                <option value="">-</option>
                                <option value="S">‚úÖ S</option>
                                <option value="N">‚ùå N</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sensoreLuce">Sensore Luce</label>
                            <select id="sensoreLuce" name="sensoreLuce">
                                <option value="">-</option>
                                <option value="S">‚úÖ S</option>
                                <option value="N">‚ùå N</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sensoreEcg">Sensore ECG</label>
                            <select id="sensoreEcg" name="sensoreEcg">
                                <option value="">-</option>
                                <option value="S">‚úÖ S</option>
                                <option value="N">‚ùå N</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label for="note">Note Aggiuntive</label>
                            <textarea id="note" name="note" placeholder="Eventuali informazioni aggiuntive rilevanti..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- ALTRI CONTATTI -->
                <div class="section">
                    <h2 class="section-title">üìû ALTRI CONTATTI</h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="assSocialeNome">Nominativo Ass. Sociale</label>
                            <input type="text" id="assSocialeNome" name="assSocialeNome" placeholder="Nome e Cognome">
                        </div>
                        <div class="form-group">
                            <label for="assSocialeCellulare">N¬∞ Cellulare Ass. Sociale</label>
                            <input type="tel" id="assSocialeCellulare" name="assSocialeCellulare" placeholder="3331234567">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="ossNome">Nominativo OSS</label>
                            <input type="text" id="ossNome" name="ossNome" placeholder="Nome e Cognome">
                        </div>
                        <div class="form-group">
                            <label for="ossCellulare">N¬∞ Cellulare OSS</label>
                            <input type="tel" id="ossCellulare" name="ossCellulare" placeholder="3331234567">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="infermiereNome">Nominativo Infermiere</label>
                            <input type="text" id="infermiereNome" name="infermiereNome" placeholder="Nome e Cognome">
                        </div>
                        <div class="form-group">
                            <label for="infermiereCellulare">N¬∞ Cellulare Infermiere</label>
                            <input type="tel" id="infermiereCellulare" name="infermiereCellulare" placeholder="3331234567">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="mmgNome">Nominativo MMG</label>
                            <input type="text" id="mmgNome" name="mmgNome" placeholder="Nome e Cognome">
                        </div>
                        <div class="form-group">
                            <label for="mmgCellulare">N¬∞ Cellulare MMG</label>
                            <input type="tel" id="mmgCellulare" name="mmgCellulare" placeholder="3331234567">
                        </div>
                    </div>
                </div>

                <!-- INSTALLAZIONE -->
                <div class="section">
                    <h2 class="section-title">‚öôÔ∏è Installazione</h2>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="serialeDispositivo">Seriale Dispositivo</label>
                            <input type="text" id="serialeDispositivo" name="serialeDispositivo" placeholder="SN...">
                        </div>
                        <div class="form-group">
                            <label for="installazionePoltrona">Poltrona Installata</label>
                            <select id="installazionePoltrona" name="installazionePoltrona">
                                <option value="">-</option>
                                <option value="SI">‚úÖ SI</option>
                                <option value="NO">‚ùå NO</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="installazioneSensoreLuce">Sensore Luce Installato</label>
                            <select id="installazioneSensoreLuce" name="installazioneSensoreLuce">
                                <option value="">-</option>
                                <option value="SI">‚úÖ SI</option>
                                <option value="NO">‚ùå NO</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="installazioneSensoreEcg">Sensore ECG Installato</label>
                            <select id="installazioneSensoreEcg" name="installazioneSensoreEcg">
                                <option value="">-</option>
                                <option value="SI">‚úÖ SI</option>
                                <option value="NO">‚ùå NO</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn-primary">
                        üíæ SALVA
                    </button>
                    <button type="button" class="btn-secondary" onclick="nuovaScheda()">
                        ‚ú® Nuova Scheda
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingText">Caricamento in corso...</p>
        </div>
    </div>

    <!-- Modal Lista Schede -->
    <div id="listaSchedeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã Schede su Google Sheets</h2>
                <span class="close-btn" onclick="chiudiModal()">&times;</span>
            </div>
            
            <div class="filter-bar">
                <label for="filtroComune" style="margin-right: 10px;"><strong>Filtra per Comune:</strong></label>
                <select id="filtroComune" onchange="filtraSchedePerComune()">
                    <option value="">üåç Tutti i Comuni</option>
                    <option value="Trapani">Trapani (46)</option>
                    <option value="Erice">Erice (19)</option>
                    <option value="Valderice">Valderice (8)</option>
                    <option value="Paceco">Paceco (8)</option>
                    <option value="Misiliscemi">Misiliscemi (7)</option>
                    <option value="Custonaci">Custonaci (4)</option>
                    <option value="San Vito Lo Capo">San Vito Lo Capo (3)</option>
                    <option value="Favignana">Favignana (3)</option>
                    <option value="Buseto Palizzolo">Buseto Palizzolo (2)</option>
                </select>
            </div>
            
            <div id="listaSchedeContent" class="schede-list"></div>
        </div>
    </div>

    <!-- Modal Statistiche -->
    <div id="statisticheModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìä Statistiche per Comune - Distretto 50</h2>
                <span class="close-btn" onclick="chiudiModalStatistiche()">&times;</span>
            </div>
            <div id="statisticheContent"></div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURAZIONE HARDCODED
        // INSERIRE QUI L'URL DEL GOOGLE APPS SCRIPT
        // ============================================
        const DEPLOY_URL = 'https://script.google.com/macros/s/AKfycbyg9Bqnft159u1VRQ7-nm2TRGQox9s-t0y0ORs38WIouWVILdBUK692dy6M-gNTellFqw/exec';
        
        // Esempio:
        // const DEPLOY_URL = 'https://script.google.com/macros/s/AKfycbxXXXXXXXXX/exec';
        
        // ============================================
        
        let schedeCache = [];
        let schedeFiltrate = [];

        // Obiettivi ufficiali per comune dalla MdI 03/09/2025
        const OBIETTIVI_COMUNI = {
            'Trapani': 46,
            'Erice': 19,
            'Valderice': 8,
            'Paceco': 8,
            'Misiliscemi': 7,
            'Custonaci': 4,
            'San Vito Lo Capo': 3,
            'Favignana': 3,
            'Buseto Palizzolo': 2
        };

        // Fallback assoluto: dopo 6 secondi forza stato utilizzabile
        let inizializzazioneCompletata = false;
        
        setTimeout(function() {
            if (!inizializzazioneCompletata) {
                console.warn('FALLBACK: Inizializzazione forzata dopo 6 secondi');
                aggiornaStato('disconnected', '‚ö†Ô∏è Modalit√† offline');
                inizializzazioneCompletata = true;
            }
        }, 6000);
        
        // Inizializzazione al caricamento pagina
        function inizializza() {
            console.log('Funzione inizializza() chiamata');
            
            try {
                const configured = verificaConfigurazione();
                impostaDataOggi();
                setupDateInputs();
                
                // Carica schede solo se configurato correttamente
                if (configured) {
                    // Non chiamare caricaSchede qui, viene chiamata dallo script immediato
                    console.log('URL configurato, caricamento delegato a script immediato');
                    
                    // Marca come completata dopo il primo tentativo
                    setTimeout(function() {
                        inizializzazioneCompletata = true;
                        console.log('Inizializzazione marcata come completata');
                    }, 1000);
                } else {
                    aggiornaStato('disconnected', '‚ö†Ô∏è Configurazione richiesta');
                    inizializzazioneCompletata = true;
                }
            } catch (e) {
                console.error('Errore in inizializza():', e);
                aggiornaStato('disconnected', '‚ùå Errore inizializzazione');
                inizializzazioneCompletata = true;
            }
        }
        
        // Prova DOMContentLoaded
        window.addEventListener('DOMContentLoaded', inizializza);
        
        // Fallback per Safari iOS: prova anche 'load'
        window.addEventListener('load', function() {
            if (!inizializzazioneCompletata) {
                console.log('Evento load triggered, inizializzazione non ancora completata');
                inizializza();
            }
        });
        
        // Ultimo fallback: se dopo 500ms non √® partito nulla, avvia manualmente
        setTimeout(function() {
            if (typeof setupDateInputs === 'function' && document.getElementById('giorno')) {
                const giorno = document.getElementById('giorno');
                if (!giorno.hasAttribute('data-initialized')) {
                    console.warn('Fallback 500ms: setupDateInputs non eseguito, avvio manuale');
                    inizializza();
                }
            }
        }, 500);

        // Setup campi data di nascita con salto automatico
        function setupDateInputs() {
            const giorno = document.getElementById('giorno');
            const mese = document.getElementById('mese');
            const anno = document.getElementById('anno');
            
            // Marca come inizializzato
            giorno.setAttribute('data-initialized', 'true');
            console.log('setupDateInputs() eseguita, campi marcati');

            // Auto-jump tra campi
            giorno.addEventListener('input', function() {
                if (this.value.length === 2) {
                    mese.focus();
                }
                calcolaEta();
            });

            mese.addEventListener('input', function() {
                if (this.value.length === 2) {
                    anno.focus();
                }
                calcolaEta();
            });

            anno.addEventListener('input', function() {
                calcolaEta();
            });

            // Calcola et√† anche quando si esce dai campi
            giorno.addEventListener('blur', calcolaEta);
            mese.addEventListener('blur', calcolaEta);
            anno.addEventListener('blur', calcolaEta);
        }

        // Calcola et√† e aggiorna display
        function calcolaEta() {
            const giorno = parseInt(document.getElementById('giorno').value);
            const mese = parseInt(document.getElementById('mese').value);
            const anno = parseInt(document.getElementById('anno').value);
            const ageDisplay = document.getElementById('ageDisplay');

            if (giorno && mese && anno && giorno >= 1 && giorno <= 31 && mese >= 1 && mese <= 12 && anno >= 1900 && anno <= 2025) {
                // Crea data di nascita
                const dataNascita = new Date(anno, mese - 1, giorno);
                const oggi = new Date();
                
                // Calcola et√†
                let eta = oggi.getFullYear() - dataNascita.getFullYear();
                const differenzaMesi = oggi.getMonth() - dataNascita.getMonth();
                
                if (differenzaMesi < 0 || (differenzaMesi === 0 && oggi.getDate() < dataNascita.getDate())) {
                    eta--;
                }

                // Aggiorna display
                ageDisplay.className = 'age-display';
                ageDisplay.innerHTML = `üéÇ ${eta} anni`;

                // Aggiorna campo hidden per backend
                const dataFormatted = `${anno}-${String(mese).padStart(2, '0')}-${String(giorno).padStart(2, '0')}`;
                document.getElementById('dataNascita').value = dataFormatted;
            } else {
                ageDisplay.className = 'age-display empty';
                ageDisplay.innerHTML = 'üéÇ - anni';
                document.getElementById('dataNascita').value = '';
            }
        }

        // Verifica che l'URL sia stato configurato
        function verificaConfigurazione() {
            // Controllo file locale
            if (window.location.protocol === 'file:') {
                aggiornaStato('disconnected', '‚ö†Ô∏è File locale - Carica su web');
                mostraMessaggio('error', '‚ö†Ô∏è ATTENZIONE: Stai aprendo il file in LOCALE.\n\nSu iPhone, Safari blocca le connessioni da file locali per sicurezza.\n\nSOLUZIONE:\n1. Carica il file su Google Drive\n2. Ottieni link condivisibile\n3. Apri il link con Safari\n\nIn alternativa usa GitHub Pages.');
                return false;
            }
            
            if (!DEPLOY_URL || DEPLOY_URL === 'INSERIRE_QUI_URL_GOOGLE_APPS_SCRIPT') {
                aggiornaStato('disconnected', '‚ö†Ô∏è URL Google Apps Script non configurato');
                mostraMessaggio('error', '‚ö†Ô∏è ATTENZIONE: Devi configurare l\'URL del Google Apps Script nel codice HTML prima di utilizzare il modulo.');
                return false;
            }
            return true;
        }

        // Imposta data di oggi nel campo dataCompilazione
        function impostaDataOggi() {
            const oggi = new Date().toISOString().split('T')[0];
            document.getElementById('dataCompilazione').value = oggi;
        }

        // Gestione submit form
        document.getElementById('assistitoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!verificaConfigurazione()) {
                return;
            }
            
            salvaScheda();
        });

        // Salva scheda su Google Sheets
        function salvaScheda() {
            const formData = new FormData(document.getElementById('assistitoForm'));
            const schedaData = {};
            
            formData.forEach((value, key) => {
                schedaData[key] = value;
            });

            mostraLoading('Salvataggio in corso...');

            fetch(DEPLOY_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'save',
                    data: schedaData
                })
            })
            .then(() => {
                nascondiLoading();
                mostraMessaggio('success', `‚úÖ Salvataggio effettuato! Scheda N¬∞ ${schedaData.numeroScheda} salvata con successo.`);
                
                setTimeout(() => {
                    caricaSchede();
                    nuovaSchedaAutomatico();
                }, 1500);
            })
            .catch(error => {
                nascondiLoading();
                console.error('Errore:', error);
                mostraMessaggio('info', `‚ÑπÔ∏è Scheda inviata al server. Apertura nuova scheda...`);
                
                setTimeout(() => {
                    caricaSchede();
                    nuovaSchedaAutomatico();
                }, 2000);
            });
        }

        // Nuova scheda automatica (senza conferma)
        function nuovaSchedaAutomatico() {
            document.getElementById('assistitoForm').reset();
            impostaDataOggi();
            
            // Reset et√† display
            const ageDisplay = document.getElementById('ageDisplay');
            ageDisplay.className = 'age-display empty';
            ageDisplay.innerHTML = 'üéÇ - anni';
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Carica tutte le schede da Google Sheets
        function caricaSchede() {
            if (!verificaConfigurazione()) {
                return;
            }

            console.log('caricaSchede() - Inizio');
            aggiornaStato('loading', 'Caricamento schede...');

            // Timeout ridotto a 5 secondi per iPhone
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                console.log('Timeout raggiunto (5s)');
                controller.abort();
            }, 5000);

            console.log('Avvio fetch verso:', DEPLOY_URL + '?action=getAll');

            fetch(DEPLOY_URL + '?action=getAll', { 
                signal: controller.signal,
                method: 'GET',
                mode: 'cors',
                cache: 'no-cache'
            })
                .then(response => {
                    clearTimeout(timeoutId);
                    console.log('Risposta ricevuta, status:', response.status);
                    
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status);
                    }
                    
                    return response.json();
                })
                .then(data => {
                    console.log('Dati parsati:', data);
                    
                    if (data.success) {
                        schedeCache = data.data || [];
                        schedeFiltrate = schedeCache;
                        
                        console.log('Schede caricate:', schedeCache.length);
                        aggiornaStato('connected', `‚úÖ Connesso - ${schedeCache.length} schede caricate`);
                        document.getElementById('totalSchede').textContent = schedeCache.length;
                        
                        aggiornaStatistiche();
                    } else {
                        console.error('Errore nel response data:', data.message);
                        aggiornaStato('disconnected', '‚ùå Errore caricamento');
                    }
                })
                .catch(error => {
                    clearTimeout(timeoutId);
                    console.error('Errore catch:', error.name, error.message);
                    
                    if (error.name === 'AbortError') {
                        console.log('Fetch abortita per timeout');
                        aggiornaStato('disconnected', '‚è±Ô∏è Timeout (5s)');
                        // Non bloccare l'utente, permetti comunque l'uso del form
                    } else {
                        console.log('Errore di rete o altro:', error.message);
                        aggiornaStato('disconnected', '‚ùå Errore: ' + error.message.substring(0, 20));
                    }
                    
                    // In ogni caso, il form deve essere utilizzabile
                    console.log('Form utilizzabile nonostante errore');
                });
        }

        // Aggiorna stato connessione
        function aggiornaStato(stato, testo) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            statusDot.className = 'status-dot ' + stato;
            statusText.textContent = testo;
        }

        // Mostra messaggio
        function mostraMessaggio(tipo, testo) {
            const messageBox = document.getElementById('messageBox');
            messageBox.className = 'message ' + tipo;
            messageBox.textContent = testo;
            messageBox.style.display = 'block';
            
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000);
        }

        // Mostra/nascondi loading
        function mostraLoading(testo) {
            document.getElementById('loadingText').textContent = testo;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function nascondiLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Aggiorna statistiche nella barra superiore
        function aggiornaStatistiche() {
            const statsBar = document.getElementById('statsBar');
            
            if (schedeCache.length === 0) {
                statsBar.style.display = 'none';
                return;
            }
            
            statsBar.style.display = 'flex';
            
            // Conta per comune
            const conteggioComuni = {};
            schedeCache.forEach(scheda => {
                const comune = scheda.comune;
                if (comune) {
                    conteggioComuni[comune] = (conteggioComuni[comune] || 0) + 1;
                }
            });
            
            // Totale assistiti
            document.getElementById('statTotale').textContent = schedeCache.length;
            
            // Comuni coperti
            document.getElementById('statComune').textContent = Object.keys(conteggioComuni).length;
            
            // Comune con pi√π assistiti
            let maxComune = '';
            let maxCount = 0;
            Object.entries(conteggioComuni).forEach(([comune, count]) => {
                if (count > maxCount) {
                    maxCount = count;
                    maxComune = comune;
                }
            });
            document.getElementById('statPiuComune').textContent = maxComune ? `${maxComune} (${maxCount})` : '-';
        }

        // Mostra lista schede in modal
        function mostraListaSchede() {
            if (schedeCache.length === 0) {
                mostraMessaggio('info', 'Nessuna scheda disponibile');
                return;
            }
            
            const modal = document.getElementById('listaSchedeModal');
            const content = document.getElementById('listaSchedeContent');
            
            content.innerHTML = '';
            
            schedeFiltrate.forEach(scheda => {
                const item = document.createElement('div');
                item.className = 'scheda-item';
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="font-size: 18px; color: #667eea;">Scheda N¬∞ ${scheda.numeroScheda}</strong><br>
                            <span style="font-size: 16px; color: #333;">${scheda.nome} ${scheda.cognome}</span><br>
                            <span style="font-size: 14px; color: #666;">üìç ${scheda.comune}</span>
                        </div>
                        <div style="text-align: right;">
                            <span style="font-size: 12px; color: #999;">üìÖ ${scheda.dataCompilazione || 'N/D'}</span>
                        </div>
                    </div>
                `;
                
                item.onclick = () => caricaSchedaInForm(scheda);
                
                content.appendChild(item);
            });
            
            modal.style.display = 'block';
        }

        // Carica scheda nel form per modifica
        function caricaSchedaInForm(scheda) {
            // Reset form
            document.getElementById('assistitoForm').reset();
            
            // Carica campi normali
            Object.keys(scheda).forEach(key => {
                const input = document.getElementById(key);
                if (input && key !== 'dataNascita') {
                    input.value = scheda[key] || '';
                }
            });
            
            // Gestione data di nascita
            if (scheda.dataNascita) {
                const parts = scheda.dataNascita.split('-');
                if (parts.length === 3) {
                    document.getElementById('anno').value = parts[0];
                    document.getElementById('mese').value = parseInt(parts[1]);
                    document.getElementById('giorno').value = parseInt(parts[2]);
                    calcolaEta();
                }
            }
            
            chiudiModal();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            mostraMessaggio('info', `üìù Scheda N¬∞ ${scheda.numeroScheda} caricata per modifica`);
        }

        // Filtra schede per comune
        function filtraSchedePerComune() {
            const filtroComune = document.getElementById('filtroComune').value;
            
            if (filtroComune === '') {
                schedeFiltrate = schedeCache;
            } else {
                schedeFiltrate = schedeCache.filter(scheda => scheda.comune === filtroComune);
            }
            
            mostraListaSchede();
        }

        // Mostra statistiche dettagliate
        function mostraStatistiche() {
            if (schedeCache.length === 0) {
                mostraMessaggio('info', 'Nessuna scheda disponibile per statistiche');
                return;
            }
            
            const modal = document.getElementById('statisticheModal');
            const content = document.getElementById('statisticheContent');
            
            // Conta per comune
            const conteggioComuni = {};
            schedeCache.forEach(scheda => {
                const comune = scheda.comune;
                if (comune) {
                    conteggioComuni[comune] = (conteggioComuni[comune] || 0) + 1;
                }
            });
            
            let html = '<div style="overflow-x: auto;">';
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 20px;">';
            html += '<thead><tr style="background: #667eea; color: white;">';
            html += '<th style="padding: 12px; text-align: left;">Comune</th>';
            html += '<th style="padding: 12px; text-align: center;">Assistiti Attuali</th>';
            html += '<th style="padding: 12px; text-align: center;">Obiettivo</th>';
            html += '<th style="padding: 12px; text-align: center;">% Completamento</th>';
            html += '<th style="padding: 12px; text-align: center;">Mancanti</th>';
            html += '<th style="padding: 12px; text-align: center;">Stato</th>';
            html += '</tr></thead><tbody>';
            
            Object.entries(OBIETTIVI_COMUNI).sort((a, b) => b[1] - a[1]).forEach(([comune, obiettivo]) => {
                const count = conteggioComuni[comune] || 0;
                const percentuale = ((count / obiettivo) * 100).toFixed(1);
                const mancanti = Math.max(0, obiettivo - count);
                
                let stato = '';
                let coloreSfondo = '';
                
                if (parseFloat(percentuale) >= 100) {
                    stato = '‚úÖ Completato';
                    coloreSfondo = '#d4edda';
                } else if (parseFloat(percentuale) >= 75) {
                    stato = 'üü¢ Ottimo';
                    coloreSfondo = '#fff3cd';
                } else if (parseFloat(percentuale) >= 50) {
                    stato = 'üü° In corso';
                    coloreSfondo = '#ffe5cc';
                } else if (parseFloat(percentuale) > 0) {
                    stato = 'üü† In ritardo';
                    coloreSfondo = '#f8d7da';
                } else {
                    stato = '‚ö™ Non iniziato';
                    coloreSfondo = '#f8f9fa';
                }
                
                html += `<tr style="border-bottom: 1px solid #e0e0e0;">`;
                html += `<td style="padding: 12px;"><strong>${comune}</strong></td>`;
                html += `<td style="padding: 12px; text-align: center; font-weight: bold; font-size: 18px; color: #667eea;">${count}</td>`;
                html += `<td style="padding: 12px; text-align: center; font-weight: bold;">${obiettivo}</td>`;
                html += `<td style="padding: 12px; text-align: center;">${percentuale}%</td>`;
                html += `<td style="padding: 12px; text-align: center;">${mancanti}</td>`;
                html += `<td style="padding: 12px; text-align: center; background: ${coloreSfondo}; font-weight: bold;">${stato}</td>`;
                html += `</tr>`;
            });
            
            html += '</tbody></table></div>';
            
            // Totale generale
            const totale = schedeCache.length;
            const percentualeTotale = ((totale / 100) * 100).toFixed(1);
            
            html += `<div style="margin-top: 30px; padding: 20px; background: #f0f3ff; border-radius: 10px; border: 2px solid #667eea;">`;
            html += `<h3 style="color: #667eea; margin-bottom: 15px;">üìä Riepilogo Generale</h3>`;
            html += `<p style="font-size: 16px; margin-bottom: 10px;"><strong>Totale Assistiti:</strong> ${totale} / 100</p>`;
            html += `<p style="font-size: 16px; margin-bottom: 10px;"><strong>Completamento:</strong> ${percentualeTotale}%</p>`;
            html += `<p style="font-size: 16px;"><strong>Comuni Coperti:</strong> ${Object.keys(conteggioComuni).length} / 9</p>`;
            html += `</div>`;
            
            content.innerHTML = html;
            modal.style.display = 'block';
        }

        // Chiudi modal
        function chiudiModal() {
            document.getElementById('listaSchedeModal').style.display = 'none';
        }

        function chiudiModalStatistiche() {
            document.getElementById('statisticheModal').style.display = 'none';
        }

        // Nuova scheda (con conferma - dal pulsante)
        function nuovaScheda() {
            if (confirm('Vuoi creare una nuova scheda? I dati non salvati andranno persi.')) {
                nuovaSchedaAutomatico();
                mostraMessaggio('info', '‚ú® Nuovo modulo pronto per la compilazione');
            }
        }

        // Chiudi modal cliccando fuori
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
    
    <!-- INIZIALIZZAZIONE IMMEDIATA (eseguita subito, non aspetta eventi) -->
    <script>
        // Questo script si esegue IMMEDIATAMENTE appena viene letto dal browser
        (function() {
            console.log('Script inizializzazione IMMEDIATA eseguito');
            
            // üö® RILEVA SE FILE √à APERTO IN LOCALE
            if (window.location.protocol === 'file:') {
                console.error('‚ö†Ô∏è FILE LOCALE RILEVATO!');
                console.error('Protocollo: file:// - Le fetch verso Google Apps Script sono BLOCCATE da iOS');
                console.error('SOLUZIONE: Carica il file su Google Drive o GitHub Pages');
                
                // Mostra avviso visibile
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                if (statusDot && statusText) {
                    statusDot.className = 'status-dot disconnected';
                    statusText.innerHTML = '‚ö†Ô∏è <strong>FILE LOCALE</strong> - Carica su web per salvare dati';
                    statusText.style.color = '#ff0000';
                    statusText.style.fontSize = '13px';
                }
                
                // Mostra alert su mobile
                if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                    setTimeout(function() {
                        alert('‚ö†Ô∏è ATTENZIONE\n\nStai aprendo il file in LOCALE (da WhatsApp/Files).\n\nSu iPhone, i file locali NON possono salvare su Google Sheets per restrizioni di sicurezza iOS.\n\nSOLUZIONE:\n1. Carica il file su Google Drive\n2. Apri da Drive con Safari\n\nOppure contatta l\'amministratore.');
                    }, 1000);
                }
                
                // Non tentare fetch se file locale
                return;
            }
            
            // Imposta data di oggi appena possibile
            try {
                const oggi = new Date().toISOString().split('T')[0];
                const dataField = document.getElementById('dataCompilazione');
                if (dataField) {
                    dataField.value = oggi;
                    console.log('Data impostata immediatamente:', oggi);
                }
            } catch (e) {
                console.error('Errore imposta data immediata:', e);
            }
            
            // Cambia stato da "Pronto per l'uso" a "Caricamento" se JavaScript funziona
            try {
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                if (statusDot && statusText) {
                    statusDot.className = 'status-dot loading';
                    statusText.textContent = 'Caricamento schede...';
                    console.log('Stato cambiato a Caricamento');
                }
            } catch (e) {
                console.error('Errore cambio stato:', e);
            }
            
            // Avvia caricamento schede dopo 100ms
            setTimeout(function() {
                console.log('Tentativo caricamento schede dopo 100ms');
                if (typeof caricaSchede === 'function') {
                    try {
                        caricaSchede();
                        console.log('caricaSchede() chiamata con successo');
                    } catch (e) {
                        console.error('Errore in caricaSchede():', e);
                        // Se fallisce, torna a "Pronto per l'uso"
                        const statusDot = document.getElementById('statusDot');
                        const statusText = document.getElementById('statusText');
                        if (statusDot && statusText) {
                            statusDot.className = 'status-dot connected';
                            statusText.textContent = '‚úÖ Pronto per l\'uso (offline)';
                        }
                    }
                } else {
                    console.warn('caricaSchede() non ancora definita');
                }
            }, 100);
            
            // Fallback definitivo: dopo 7 secondi forza stato OK
            setTimeout(function() {
                const statusText = document.getElementById('statusText');
                if (statusText && (statusText.textContent.includes('Inizializzazione') || statusText.textContent.includes('Caricamento'))) {
                    console.warn('FALLBACK DEFINITIVO: 7 secondi, forzo stato utilizzabile');
                    const statusDot = document.getElementById('statusDot');
                    if (statusDot) statusDot.className = 'status-dot connected';
                    if (statusText) statusText.textContent = '‚úÖ Pronto per l\'uso';
                }
            }, 7000);
            
            console.log('Script inizializzazione IMMEDIATA completato');
        })();
    </script>
</body>
</html>
